/**
 * Copyright 2013-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the BSD-style license found in the
 * LICENSE file in the root directory of this source tree. An additional grant
 * of patent rights can be found in the PATENTS file in the same directory.
 *
 */

/* global hasOwnProperty:true */

'use strict';

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; };

var _prodInvariant = require('./reactProdInvariant'),
    _assign = require('object-assign');

var invariant = require('fbjs/lib/invariant');
var hasOwnProperty = {}.hasOwnProperty;

function shallowCopy(x) {
  if (Array.isArray(x)) {
    return x.concat();
  } else if (x && (typeof x === 'undefined' ? 'undefined' : _typeof(x)) === 'object') {
    return _assign(new x.constructor(), x);
  } else {
    return x;
  }
}

var COMMAND_PUSH = '$push';
var COMMAND_UNSHIFT = '$unshift';
var COMMAND_SPLICE = '$splice';
var COMMAND_SET = '$set';
var COMMAND_MERGE = '$merge';
var COMMAND_APPLY = '$apply';

var ALL_COMMANDS_LIST = [COMMAND_PUSH, COMMAND_UNSHIFT, COMMAND_SPLICE, COMMAND_SET, COMMAND_MERGE, COMMAND_APPLY];

var ALL_COMMANDS_SET = {};

ALL_COMMANDS_LIST.forEach(function (command) {
  ALL_COMMANDS_SET[command] = true;
});

function invariantArrayCase(value, spec, command) {
  !Array.isArray(value) ? process.env.NODE_ENV !== 'production' ? invariant(false, 'update(): expected target of %s to be an array; got %s.', command, value) : _prodInvariant('1', command, value) : void 0;
  var specValue = spec[command];
  !Array.isArray(specValue) ? process.env.NODE_ENV !== 'production' ? invariant(false, 'update(): expected spec of %s to be an array; got %s. Did you forget to wrap your parameter in an array?', command, specValue) : _prodInvariant('2', command, specValue) : void 0;
}

/**
 * Returns a updated shallow copy of an object without mutating the original.
 * See https://facebook.github.io/react/docs/update.html for details.
 */
function update(value, spec) {
  !((typeof spec === 'undefined' ? 'undefined' : _typeof(spec)) === 'object') ? process.env.NODE_ENV !== 'production' ? invariant(false, 'update(): You provided a key path to update() that did not contain one of %s. Did you forget to include {%s: ...}?', ALL_COMMANDS_LIST.join(', '), COMMAND_SET) : _prodInvariant('3', ALL_COMMANDS_LIST.join(', '), COMMAND_SET) : void 0;

  if (hasOwnProperty.call(spec, COMMAND_SET)) {
    !(Object.keys(spec).length === 1) ? process.env.NODE_ENV !== 'production' ? invariant(false, 'Cannot have more than one key in an object with %s', COMMAND_SET) : _prodInvariant('4', COMMAND_SET) : void 0;

    return spec[COMMAND_SET];
  }

  var nextValue = shallowCopy(value);

  if (hasOwnProperty.call(spec, COMMAND_MERGE)) {
    var mergeObj = spec[COMMAND_MERGE];
    !(mergeObj && (typeof mergeObj === 'undefined' ? 'undefined' : _typeof(mergeObj)) === 'object') ? process.env.NODE_ENV !== 'production' ? invariant(false, 'update(): %s expects a spec of type \'object\'; got %s', COMMAND_MERGE, mergeObj) : _prodInvariant('5', COMMAND_MERGE, mergeObj) : void 0;
    !(nextValue && (typeof nextValue === 'undefined' ? 'undefined' : _typeof(nextValue)) === 'object') ? process.env.NODE_ENV !== 'production' ? invariant(false, 'update(): %s expects a target of type \'object\'; got %s', COMMAND_MERGE, nextValue) : _prodInvariant('6', COMMAND_MERGE, nextValue) : void 0;
    _assign(nextValue, spec[COMMAND_MERGE]);
  }

  if (hasOwnProperty.call(spec, COMMAND_PUSH)) {
    invariantArrayCase(value, spec, COMMAND_PUSH);
    spec[COMMAND_PUSH].forEach(function (item) {
      nextValue.push(item);
    });
  }

  if (hasOwnProperty.call(spec, COMMAND_UNSHIFT)) {
    invariantArrayCase(value, spec, COMMAND_UNSHIFT);
    spec[COMMAND_UNSHIFT].forEach(function (item) {
      nextValue.unshift(item);
    });
  }

  if (hasOwnProperty.call(spec, COMMAND_SPLICE)) {
    !Array.isArray(value) ? process.env.NODE_ENV !== 'production' ? invariant(false, 'Expected %s target to be an array; got %s', COMMAND_SPLICE, value) : _prodInvariant('7', COMMAND_SPLICE, value) : void 0;
    !Array.isArray(spec[COMMAND_SPLICE]) ? process.env.NODE_ENV !== 'production' ? invariant(false, 'update(): expected spec of %s to be an array of arrays; got %s. Did you forget to wrap your parameters in an array?', COMMAND_SPLICE, spec[COMMAND_SPLICE]) : _prodInvariant('8', COMMAND_SPLICE, spec[COMMAND_SPLICE]) : void 0;
    spec[COMMAND_SPLICE].forEach(function (args) {
      !Array.isArray(args) ? process.env.NODE_ENV !== 'production' ? invariant(false, 'update(): expected spec of %s to be an array of arrays; got %s. Did you forget to wrap your parameters in an array?', COMMAND_SPLICE, spec[COMMAND_SPLICE]) : _prodInvariant('8', COMMAND_SPLICE, spec[COMMAND_SPLICE]) : void 0;
      nextValue.splice.apply(nextValue, args);
    });
  }

  if (hasOwnProperty.call(spec, COMMAND_APPLY)) {
    !(typeof spec[COMMAND_APPLY] === 'function') ? process.env.NODE_ENV !== 'production' ? invariant(false, 'update(): expected spec of %s to be a function; got %s.', COMMAND_APPLY, spec[COMMAND_APPLY]) : _prodInvariant('9', COMMAND_APPLY, spec[COMMAND_APPLY]) : void 0;
    nextValue = spec[COMMAND_APPLY](nextValue);
  }

  for (var k in spec) {
    if (!(ALL_COMMANDS_SET.hasOwnProperty(k) && ALL_COMMANDS_SET[k])) {
      nextValue[k] = update(value[k], spec[k]);
    }
  }

  return nextValue;
}

module.exports = update;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3B1YmxpYy9saWIvcmVhY3QvbGliL3VwZGF0ZS5qcyJdLCJuYW1lcyI6WyJfcHJvZEludmFyaWFudCIsInJlcXVpcmUiLCJfYXNzaWduIiwiaW52YXJpYW50IiwiaGFzT3duUHJvcGVydHkiLCJzaGFsbG93Q29weSIsIngiLCJBcnJheSIsImlzQXJyYXkiLCJjb25jYXQiLCJjb25zdHJ1Y3RvciIsIkNPTU1BTkRfUFVTSCIsIkNPTU1BTkRfVU5TSElGVCIsIkNPTU1BTkRfU1BMSUNFIiwiQ09NTUFORF9TRVQiLCJDT01NQU5EX01FUkdFIiwiQ09NTUFORF9BUFBMWSIsIkFMTF9DT01NQU5EU19MSVNUIiwiQUxMX0NPTU1BTkRTX1NFVCIsImZvckVhY2giLCJjb21tYW5kIiwiaW52YXJpYW50QXJyYXlDYXNlIiwidmFsdWUiLCJzcGVjIiwicHJvY2VzcyIsImVudiIsIk5PREVfRU5WIiwic3BlY1ZhbHVlIiwidXBkYXRlIiwiam9pbiIsImNhbGwiLCJPYmplY3QiLCJrZXlzIiwibGVuZ3RoIiwibmV4dFZhbHVlIiwibWVyZ2VPYmoiLCJpdGVtIiwicHVzaCIsInVuc2hpZnQiLCJhcmdzIiwic3BsaWNlIiwiYXBwbHkiLCJrIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7QUFVQTs7QUFFQTs7OztBQUVBLElBQUlBLGlCQUFpQkMsUUFBUSxzQkFBUixDQUFyQjtBQUFBLElBQ0lDLFVBQVVELFFBQVEsZUFBUixDQURkOztBQUdBLElBQUlFLFlBQVlGLFFBQVEsb0JBQVIsQ0FBaEI7QUFDQSxJQUFJRyxpQkFBaUIsR0FBR0EsY0FBeEI7O0FBRUEsU0FBU0MsV0FBVCxDQUFxQkMsQ0FBckIsRUFBd0I7QUFDdEIsTUFBSUMsTUFBTUMsT0FBTixDQUFjRixDQUFkLENBQUosRUFBc0I7QUFDcEIsV0FBT0EsRUFBRUcsTUFBRixFQUFQO0FBQ0QsR0FGRCxNQUVPLElBQUlILEtBQUssUUFBT0EsQ0FBUCx5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LENBQUosRUFBOEM7QUFDNUMsTUFBRSxPQUFPTyxLQUFLUCxhQUFMLENBQVAsS0FBK0IsVUFBakMsSUFBK0NRLFFBQVFDLEdBQVIsQ0FBWUMsUUFBWixLQUF5QixZQUF6QixHQUF3Q3ZCLFVBQVUsS0FBVixFQUFpQix5REFBakIsRUFBNEVhLGFBQTVFLEVBQTJGTyxLQUFLUCxhQUFMLENBQTNGLENBQXhDLEdBQTBKaEIsZUFBZSxHQUFmLEVBQW9CZ0IsYUFBcEIsRUFBbUNPLEtBQUtQLGFBQUwsQ0FBbkMsQ0FBek0sR0FBbVEsS0FBSyxDQUF4UTtBQUNBa0IsZ0JBQVlYLEtBQUtQLGFBQUwsRUFBb0JrQixTQUFwQixDQUFaO0FBQ0Q7O0FBRUQsT0FBSyxJQUFJUSxDQUFULElBQWNuQixJQUFkLEVBQW9CO0FBQ2xCLFFBQUksRUFBRUwsaUJBQWlCZCxjQUFqQixDQUFnQ3NDLENBQWhDLEtBQXNDeEIsaUJBQWlCd0IsQ0FBakIsQ0FBeEMsQ0FBSixFQUFrRTtBQUNoRVIsZ0JBQVVRLENBQVYsSUFBZWQsT0FBT04sTUFBTW9CLENBQU4sQ0FBUCxFQUFpQm5CLEtBQUttQixDQUFMLENBQWpCLENBQWY7QUFDRDtBQUNGOztBQUVELFNBQU9SLFNBQVA7QUFDRDs7QUFFRFMsT0FBT0MsT0FBUCxHQUFpQmhCLE1BQWpCIiwiZmlsZSI6InVwZGF0ZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IDIwMTMtcHJlc2VudCwgRmFjZWJvb2ssIEluYy5cbiAqIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgQlNELXN0eWxlIGxpY2Vuc2UgZm91bmQgaW4gdGhlXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuIEFuIGFkZGl0aW9uYWwgZ3JhbnRcbiAqIG9mIHBhdGVudCByaWdodHMgY2FuIGJlIGZvdW5kIGluIHRoZSBQQVRFTlRTIGZpbGUgaW4gdGhlIHNhbWUgZGlyZWN0b3J5LlxuICpcbiAqL1xuXG4vKiBnbG9iYWwgaGFzT3duUHJvcGVydHk6dHJ1ZSAqL1xuXG4ndXNlIHN0cmljdCc7XG5cbnZhciBfcHJvZEludmFyaWFudCA9IHJlcXVpcmUoJy4vcmVhY3RQcm9kSW52YXJpYW50JyksXG4gICAgX2Fzc2lnbiA9IHJlcXVpcmUoJ29iamVjdC1hc3NpZ24nKTtcblxudmFyIGludmFyaWFudCA9IHJlcXVpcmUoJ2ZianMvbGliL2ludmFyaWFudCcpO1xudmFyIGhhc093blByb3BlcnR5ID0ge30uaGFzT3duUHJvcGVydHk7XG5cbmZ1bmN0aW9uIHNoYWxsb3dDb3B5KHgpIHtcbiAgaWYgKEFycmF5LmlzQXJyYXkoeCkpIHtcbiAgICByZXR1cm4geC5jb25jYXQoKTtcbiAgfSBlbHNlIGlmICh4ICYmIHR5cGVvZiB4ID09PSAnb2JqZWN0Jykge1xuICAgIHJldHVybiBfYXNzaWduKG5ldyB4LmNvbnN0cnVjdG9yKCksIHgpO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiB4O1xuICB9XG59XG5cbnZhciBDT01NQU5EX1BVU0ggPSAnJHB1c2gnO1xudmFyIENPTU1BTkRfVU5TSElGVCA9ICckdW5zaGlmdCc7XG52YXIgQ09NTUFORF9TUExJQ0UgPSAnJHNwbGljZSc7XG52YXIgQ09NTUFORF9TRVQgPSAnJHNldCc7XG52YXIgQ09NTUFORF9NRVJHRSA9ICckbWVyZ2UnO1xudmFyIENPTU1BTkRfQVBQTFkgPSAnJGFwcGx5JztcblxudmFyIEFMTF9DT01NQU5EU19MSVNUID0gW0NPTU1BTkRfUFVTSCwgQ09NTUFORF9VTlNISUZULCBDT01NQU5EX1NQTElDRSwgQ09NTUFORF9TRVQsIENPTU1BTkRfTUVSR0UsIENPTU1BTkRfQVBQTFldO1xuXG52YXIgQUxMX0NPTU1BTkRTX1NFVCA9IHt9O1xuXG5BTExfQ09NTUFORFNfTElTVC5mb3JFYWNoKGZ1bmN0aW9uIChjb21tYW5kKSB7XG4gIEFMTF9DT01NQU5EU19TRVRbY29tbWFuZF0gPSB0cnVlO1xufSk7XG5cbmZ1bmN0aW9uIGludmFyaWFudEFycmF5Q2FzZSh2YWx1ZSwgc3BlYywgY29tbWFuZCkge1xuICAhQXJyYXkuaXNBcnJheSh2YWx1ZSkgPyBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nID8gaW52YXJpYW50KGZhbHNlLCAndXBkYXRlKCk6IGV4cGVjdGVkIHRhcmdldCBvZiAlcyB0byBiZSBhbiBhcnJheTsgZ290ICVzLicsIGNvbW1hbmQsIHZhbHVlKSA6IF9wcm9kSW52YXJpYW50KCcxJywgY29tbWFuZCwgdmFsdWUpIDogdm9pZCAwO1xuICB2YXIgc3BlY1ZhbHVlID0gc3BlY1tjb21tYW5kXTtcbiAgIUFycmF5LmlzQXJyYXkoc3BlY1ZhbHVlKSA/IHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgPyBpbnZhcmlhbnQoZmFsc2UsICd1cGRhdGUoKTogZXhwZWN0ZWQgc3BlYyBvZiAlcyB0byBiZSBhbiBhcnJheTsgZ290ICVzLiBEaWQgeW91IGZvcmdldCB0byB3cmFwIHlvdXIgcGFyYW1ldGVyIGluIGFuIGFycmF5PycsIGNvbW1hbmQsIHNwZWNWYWx1ZSkgOiBfcHJvZEludmFyaWFudCgnMicsIGNvbW1hbmQsIHNwZWNWYWx1ZSkgOiB2b2lkIDA7XG59XG5cbi8qKlxuICogUmV0dXJucyBhIHVwZGF0ZWQgc2hhbGxvdyBjb3B5IG9mIGFuIG9iamVjdCB3aXRob3V0IG11dGF0aW5nIHRoZSBvcmlnaW5hbC5cbiAqIFNlZSBodHRwczovL2ZhY2Vib29rLmdpdGh1Yi5pby9yZWFjdC9kb2NzL3VwZGF0ZS5odG1sIGZvciBkZXRhaWxzLlxuICovXG5mdW5jdGlvbiB1cGRhdGUodmFsdWUsIHNwZWMpIHtcbiAgISh0eXBlb2Ygc3BlYyA9PT0gJ29iamVjdCcpID8gcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyA/IGludmFyaWFudChmYWxzZSwgJ3VwZGF0ZSgpOiBZb3UgcHJvdmlkZWQgYSBrZXkgcGF0aCB0byB1cGRhdGUoKSB0aGF0IGRpZCBub3QgY29udGFpbiBvbmUgb2YgJXMuIERpZCB5b3UgZm9yZ2V0IHRvIGluY2x1ZGUgeyVzOiAuLi59PycsIEFMTF9DT01NQU5EU19MSVNULmpvaW4oJywgJyksIENPTU1BTkRfU0VUKSA6IF9wcm9kSW52YXJpYW50KCczJywgQUxMX0NPTU1BTkRTX0xJU1Quam9pbignLCAnKSwgQ09NTUFORF9TRVQpIDogdm9pZCAwO1xuXG4gIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHNwZWMsIENPTU1BTkRfU0VUKSkge1xuICAgICEoT2JqZWN0LmtleXMoc3BlYykubGVuZ3RoID09PSAxKSA/IHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgPyBpbnZhcmlhbnQoZmFsc2UsICdDYW5ub3QgaGF2ZSBtb3JlIHRoYW4gb25lIGtleSBpbiBhbiBvYmplY3Qgd2l0aCAlcycsIENPTU1BTkRfU0VUKSA6IF9wcm9kSW52YXJpYW50KCc0JywgQ09NTUFORF9TRVQpIDogdm9pZCAwO1xuXG4gICAgcmV0dXJuIHNwZWNbQ09NTUFORF9TRVRdO1xuICB9XG5cbiAgdmFyIG5leHRWYWx1ZSA9IHNoYWxsb3dDb3B5KHZhbHVlKTtcblxuICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChzcGVjLCBDT01NQU5EX01FUkdFKSkge1xuICAgIHZhciBtZXJnZU9iaiA9IHNwZWNbQ09NTUFORF9NRVJHRV07XG4gICAgIShtZXJnZU9iaiAmJiB0eXBlb2YgbWVyZ2VPYmogPT09ICdvYmplY3QnKSA/IHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgPyBpbnZhcmlhbnQoZmFsc2UsICd1cGRhdGUoKTogJXMgZXhwZWN0cyBhIHNwZWMgb2YgdHlwZSBcXCdvYmplY3RcXCc7IGdvdCAlcycsIENPTU1BTkRfTUVSR0UsIG1lcmdlT2JqKSA6IF9wcm9kSW52YXJpYW50KCc1JywgQ09NTUFORF9NRVJHRSwgbWVyZ2VPYmopIDogdm9pZCAwO1xuICAgICEobmV4dFZhbHVlICYmIHR5cGVvZiBuZXh0VmFsdWUgPT09ICdvYmplY3QnKSA/IHByb2Nlc3MuZW52Lk5PREVfRU5WICE9PSAncHJvZHVjdGlvbicgPyBpbnZhcmlhbnQoZmFsc2UsICd1cGRhdGUoKTogJXMgZXhwZWN0cyBhIHRhcmdldCBvZiB0eXBlIFxcJ29iamVjdFxcJzsgZ290ICVzJywgQ09NTUFORF9NRVJHRSwgbmV4dFZhbHVlKSA6IF9wcm9kSW52YXJpYW50KCc2JywgQ09NTUFORF9NRVJHRSwgbmV4dFZhbHVlKSA6IHZvaWQgMDtcbiAgICBfYXNzaWduKG5leHRWYWx1ZSwgc3BlY1tDT01NQU5EX01FUkdFXSk7XG4gIH1cblxuICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChzcGVjLCBDT01NQU5EX1BVU0gpKSB7XG4gICAgaW52YXJpYW50QXJyYXlDYXNlKHZhbHVlLCBzcGVjLCBDT01NQU5EX1BVU0gpO1xuICAgIHNwZWNbQ09NTUFORF9QVVNIXS5mb3JFYWNoKGZ1bmN0aW9uIChpdGVtKSB7XG4gICAgICBuZXh0VmFsdWUucHVzaChpdGVtKTtcbiAgICB9KTtcbiAgfVxuXG4gIGlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKHNwZWMsIENPTU1BTkRfVU5TSElGVCkpIHtcbiAgICBpbnZhcmlhbnRBcnJheUNhc2UodmFsdWUsIHNwZWMsIENPTU1BTkRfVU5TSElGVCk7XG4gICAgc3BlY1tDT01NQU5EX1VOU0hJRlRdLmZvckVhY2goZnVuY3Rpb24gKGl0ZW0pIHtcbiAgICAgIG5leHRWYWx1ZS51bnNoaWZ0KGl0ZW0pO1xuICAgIH0pO1xuICB9XG5cbiAgaWYgKGhhc093blByb3BlcnR5LmNhbGwoc3BlYywgQ09NTUFORF9TUExJQ0UpKSB7XG4gICAgIUFycmF5LmlzQXJyYXkodmFsdWUpID8gcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyA/IGludmFyaWFudChmYWxzZSwgJ0V4cGVjdGVkICVzIHRhcmdldCB0byBiZSBhbiBhcnJheTsgZ290ICVzJywgQ09NTUFORF9TUExJQ0UsIHZhbHVlKSA6IF9wcm9kSW52YXJpYW50KCc3JywgQ09NTUFORF9TUExJQ0UsIHZhbHVlKSA6IHZvaWQgMDtcbiAgICAhQXJyYXkuaXNBcnJheShzcGVjW0NPTU1BTkRfU1BMSUNFXSkgPyBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nID8gaW52YXJpYW50KGZhbHNlLCAndXBkYXRlKCk6IGV4cGVjdGVkIHNwZWMgb2YgJXMgdG8gYmUgYW4gYXJyYXkgb2YgYXJyYXlzOyBnb3QgJXMuIERpZCB5b3UgZm9yZ2V0IHRvIHdyYXAgeW91ciBwYXJhbWV0ZXJzIGluIGFuIGFycmF5PycsIENPTU1BTkRfU1BMSUNFLCBzcGVjW0NPTU1BTkRfU1BMSUNFXSkgOiBfcHJvZEludmFyaWFudCgnOCcsIENPTU1BTkRfU1BMSUNFLCBzcGVjW0NPTU1BTkRfU1BMSUNFXSkgOiB2b2lkIDA7XG4gICAgc3BlY1tDT01NQU5EX1NQTElDRV0uZm9yRWFjaChmdW5jdGlvbiAoYXJncykge1xuICAgICAgIUFycmF5LmlzQXJyYXkoYXJncykgPyBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nID8gaW52YXJpYW50KGZhbHNlLCAndXBkYXRlKCk6IGV4cGVjdGVkIHNwZWMgb2YgJXMgdG8gYmUgYW4gYXJyYXkgb2YgYXJyYXlzOyBnb3QgJXMuIERpZCB5b3UgZm9yZ2V0IHRvIHdyYXAgeW91ciBwYXJhbWV0ZXJzIGluIGFuIGFycmF5PycsIENPTU1BTkRfU1BMSUNFLCBzcGVjW0NPTU1BTkRfU1BMSUNFXSkgOiBfcHJvZEludmFyaWFudCgnOCcsIENPTU1BTkRfU1BMSUNFLCBzcGVjW0NPTU1BTkRfU1BMSUNFXSkgOiB2b2lkIDA7XG4gICAgICBuZXh0VmFsdWUuc3BsaWNlLmFwcGx5KG5leHRWYWx1ZSwgYXJncyk7XG4gICAgfSk7XG4gIH1cblxuICBpZiAoaGFzT3duUHJvcGVydHkuY2FsbChzcGVjLCBDT01NQU5EX0FQUExZKSkge1xuICAgICEodHlwZW9mIHNwZWNbQ09NTUFORF9BUFBMWV0gPT09ICdmdW5jdGlvbicpID8gcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyA/IGludmFyaWFudChmYWxzZSwgJ3VwZGF0ZSgpOiBleHBlY3RlZCBzcGVjIG9mICVzIHRvIGJlIGEgZnVuY3Rpb247IGdvdCAlcy4nLCBDT01NQU5EX0FQUExZLCBzcGVjW0NPTU1BTkRfQVBQTFldKSA6IF9wcm9kSW52YXJpYW50KCc5JywgQ09NTUFORF9BUFBMWSwgc3BlY1tDT01NQU5EX0FQUExZXSkgOiB2b2lkIDA7XG4gICAgbmV4dFZhbHVlID0gc3BlY1tDT01NQU5EX0FQUExZXShuZXh0VmFsdWUpO1xuICB9XG5cbiAgZm9yICh2YXIgayBpbiBzcGVjKSB7XG4gICAgaWYgKCEoQUxMX0NPTU1BTkRTX1NFVC5oYXNPd25Qcm9wZXJ0eShrKSAmJiBBTExfQ09NTUFORFNfU0VUW2tdKSkge1xuICAgICAgbmV4dFZhbHVlW2tdID0gdXBkYXRlKHZhbHVlW2tdLCBzcGVjW2tdKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gbmV4dFZhbHVlO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IHVwZGF0ZTsiXX0=