/**
 * Copyright 2013-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the BSD-style license found in the
 * LICENSE file in the root directory of this source tree. An additional grant
 * of patent rights can be found in the PATENTS file in the same directory.
 *
 */

'use strict';

var React = require('./React');
var ReactAddonsDOMDependencies = require('./ReactAddonsDOMDependencies');

var CSSCore = require('fbjs/lib/CSSCore');
var ReactTransitionEvents = require('./ReactTransitionEvents');

var onlyChild = require('./onlyChild');

var TICK = 17;

var ReactCSSTransitionGroupChild = React.createClass({
  displayName: 'ReactCSSTransitionGroupChild',

  propTypes: {
    name: React.PropTypes.oneOfType([React.PropTypes.string, React.PropTypes.shape({
      enter: React.PropTypes.string,
      leave: React.PropTypes.string,
      active: React.PropTypes.string
    }), React.PropTypes.shape({
      enter: React.PropTypes.string,
      enterActive: React.PropTypes.string,
      leave: React.PropTypes.string,
      leaveActive: React.PropTypes.string,
      appear: React.PropTypes.string,
      appearActive: React.PropTypes.string
    })]).isRequired,

    // Once we require timeouts to be specified, we can remove the
    // boolean flags (appear etc.) and just accept a number
    // or a bool for the timeout flags (appearTimeout etc.)
    appear: React.PropTypes.bool,
    enter: React.PropTypes.bool,
    leave: React.PropTypes.bool,
    appearTimeout: React.PropTypes.number,
    enterTimeout: React.PropTypes.number,
    leaveTimeout: React.PropTypes.number
  },

  transition: function transition(animationType, finishCallback, userSpecifiedDelay) {
    var node = ReactAddonsDOMDependencies.getReactDOM().findDOMNode(this);

    if (!node) {
      if (finishCallback) {
        finishCallback();
      }
      return;
    }

    var className = this.props.name[animationType] || this.props.name + '-' + animationType;
    var activeClassName = this.props.name[animationType + 'Active'] || className + '-active';
    var timeout = null;

    var endListener = function endListener(e) {
      if (e && e.target !== node) {
        return;
      }

      clearTimeout(timeout);

      CSSCore.removeClass(node, className);
      CSSCore.removeClass(node, activeClassName);

      ReactTransitionEvents.removeEndEventListener(node, endListener);

      // Usually this optional callback is used for informing an owner of
      // a leave animation and telling it to remove the child.
      if (finishCallback) {
        finishCallback();
      }
    };

    CSSCore.addClass(node, className);

    // Need to do this to actually trigger a transition.
    this.queueClassAndNode(activeClassName, node);

    // If the user specified a timeout delay.
    if (userSpecifiedDelay) {
      // Clean-up the animation after the specified delay
      timeout = setTimeout(endListener, userSpecifiedDelay);
      this.transitionTimeouts.push(timeout);
    } else {
      // DEPRECATED: this listener will be removed in a future version of react
      ReactTransitionEvents.addEndEventListener(node, endListener);
    }
  },

  queueClassAndNode: function queueClassAndNode(className, node) {
    this.classNameAndNodeQueue.push({
      className: className,
      node: node
    });

    if (!this.timeout) {
      this.timeout = setTimeout(this.flushClassNameAndNodeQueue, TICK);
    }
  },

  flushClassNameAndNodeQueue: function flushClassNameAndNodeQueue() {
    if (this.isMounted()) {
      this.classNameAndNodeQueue.forEach(function (obj) {
        CSSCore.addClass(obj.node, obj.className);
      });
    }
    this.classNameAndNodeQueue.length = 0;
    this.timeout = null;
  },

  componentWillMount: function componentWillMount() {
    this.classNameAndNodeQueue = [];
    this.transitionTimeouts = [];
  },

  componentWillUnmount: function componentWillUnmount() {
    if (this.timeout) {
      clearTimeout(this.timeout);
    }
    this.transitionTimeouts.forEach(function (timeout) {
      clearTimeout(timeout);
    });

    this.classNameAndNodeQueue.length = 0;
  },

  componentWillAppear: function componentWillAppear(done) {
    if (this.props.appear) {
      this.transition('appear', done, this.props.appearTimeout);
    } else {
      done();
    }
  },

  componentWillEnter: function componentWillEnter(done) {
    if (this.props.enter) {
      this.transition('enter', done, this.props.enterTimeout);
    } else {
      done();
    }
  },

  componentWillLeave: function componentWillLeave(done) {
    if (this.props.leave) {
      this.transition('leave', done, this.props.leaveTimeout);
    } else {
      done();
    }
  },

  render: function render() {
    return onlyChild(this.props.children);
  }
});

module.exports = ReactCSSTransitionGroupChild;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3B1YmxpYy9saWIvcmVhY3QvbGliL1JlYWN0Q1NTVHJhbnNpdGlvbkdyb3VwQ2hpbGQuanMiXSwibmFtZXMiOlsiUmVhY3QiLCJyZXF1aXJlIiwiUmVhY3RBZGRvbnNET01EZXBlbmRlbmNpZXMiLCJDU1NDb3JlIiwiUmVhY3RUcmFuc2l0aW9uRXZlbnRzIiwib25seUNoaWxkIiwiVElDSyIsIlJlYWN0Q1NTVHJhbnNpdGlvbkdyb3VwQ2hpbGQiLCJjcmVhdGVDbGFzcyIsImRpc3BsYXlOYW1lIiwicHJvcFR5cGVzIiwibmFtZSIsIlByb3BUeXBlcyIsIm9uZU9mVHlwZSIsInN0cmluZyIsInNoYXBlIiwiZW50ZXIiLCJsZWF2ZSIsImFjdGl2ZSIsImVudGVyQWN0aXZlIiwibGVhdmVBY3RpdmUiLCJhcHBlYXIiLCJhcHBlYXJBY3RpdmUiLCJpc1JlcXVpcmVkIiwiYm9vbCIsImFwcGVhclRpbWVvdXQiLCJudW1iZXIiLCJlbnRlclRpbWVvdXQiLCJsZWF2ZVRpbWVvdXQiLCJ0cmFuc2l0aW9uIiwiYW5pbWF0aW9uVHlwZSIsImZpbmlzaENhbGxiYWNrIiwidXNlclNwZWNpZmllZERlbGF5Iiwibm9kZSIsImdldFJlYWN0RE9NIiwiZmluZERPTU5vZGUiLCJjbGFzc05hbWUiLCJwcm9wcyIsImFjdGl2ZUNsYXNzTmFtZSIsInRpbWVvdXQiLCJlbmRMaXN0ZW5lciIsImUiLCJ0YXJnZXQiLCJjbGVhclRpbWVvdXQiLCJyZW1vdmVDbGFzcyIsInJlbW92ZUVuZEV2ZW50TGlzdGVuZXIiLCJhZGRDbGFzcyIsInF1ZXVlQ2xhc3NBbmROb2RlIiwic2V0VGltZW91dCIsInRyYW5zaXRpb25UaW1lb3V0cyIsInB1c2giLCJhZGRFbmRFdmVudExpc3RlbmVyIiwiY2xhc3NOYW1lQW5kTm9kZVF1ZXVlIiwiZmx1c2hDbGFzc05hbWVBbmROb2RlUXVldWUiLCJpc01vdW50ZWQiLCJmb3JFYWNoIiwib2JqIiwibGVuZ3RoIiwiY29tcG9uZW50V2lsbE1vdW50IiwiY29tcG9uZW50V2lsbFVubW91bnQiLCJjb21wb25lbnRXaWxsQXBwZWFyIiwiZG9uZSIsImNvbXBvbmVudFdpbGxFbnRlciIsImNvbXBvbmVudFdpbGxMZWF2ZSIsInJlbmRlciIsImNoaWxkcmVuIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7QUFVQTs7QUFFQSxJQUFJQSxRQUFRQyxRQUFRLFNBQVIsQ0FBWjtBQUNBLElBQUlDLDZCQUE2QkQsUUFBUSw4QkFBUixDQUFqQzs7QUFFQSxJQUFJRSxVQUFVRixRQUFRLGtCQUFSLENBQWQ7QUFDQSxJQUFJRyx3QkFBd0JILFFBQVEseUJBQVIsQ0FBNUI7O0FBRUEsSUFBSUksWUFBWUosUUFBUSxhQUFSLENBQWhCOztBQUVBLElBQUlLLE9BQU8sRUFBWDs7QUFFQSxJQUFJQywrQkFBK0JQLE1BQU1RLFdBQU4sQ0FBa0I7QUFDbkRDLGVBQWEsOEJBRHNDOztBQUduREMsYUFBVztBQUNUQyxVQUFNWCxNQUFNWSxTQUFOLENBQWdCQyxTQUFoQixDQUEwQixDQUFDYixNQUFNWSxTQUFOLENBQWdCRSxNQUFqQixFQUF5QmQsTUFBTVksU0FBTixDQUFnQkcsS0FBaEIsQ0FBc0I7QUFDN0VDLGFBQU9oQixNQUFNWSxTQUFOLENBQWdCRSxNQURzRDtBQUU3RUcsYUFBT2pCLE1BQU1ZLFNBQU4sQ0FBZ0JFLE1BRnNEO0FBRzdFSSxjQUFRbEIsTUFBTVksU0FBTixDQUFnQkU7QUFIcUQsS0FBdEIsQ0FBekIsRUFJNUJkLE1BQU1ZLFNBQU4sQ0FBZ0JHLEtBQWhCLENBQXNCO0FBQ3hCQyxhQUFPaEIsTUFBTVksU0FBTixDQUFnQkUsTUFEQztBQUV4QkssbUJBQWFuQixNQUFNWSxTQUFOLENBQWdCRSxNQUZMO0FBR3hCRyxhQUFPakIsTUFBTVksU0FBTixDQUFnQkUsTUFIQztBQUl4Qk0sbUJBQWFwQixNQUFNWSxTQUFOLENBQWdCRSxNQUpMO0FBS3hCTyxjQUFRckIsTUFBTVksU0FBTixDQUFnQkUsTUFMQTtB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LE1BRU87QUFDTGlDO0FBQ0Q7QUFDRixHQXhJa0Q7O0FBMEluREcsVUFBUSxrQkFBWTtBQUNsQixXQUFPM0QsVUFBVSxLQUFLZ0MsS0FBTCxDQUFXNEIsUUFBckIsQ0FBUDtBQUNEO0FBNUlrRCxDQUFsQixDQUFuQzs7QUErSUFDLE9BQU9DLE9BQVAsR0FBaUI1RCw0QkFBakIiLCJmaWxlIjoiUmVhY3RDU1NUcmFuc2l0aW9uR3JvdXBDaGlsZC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IDIwMTMtcHJlc2VudCwgRmFjZWJvb2ssIEluYy5cbiAqIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgQlNELXN0eWxlIGxpY2Vuc2UgZm91bmQgaW4gdGhlXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuIEFuIGFkZGl0aW9uYWwgZ3JhbnRcbiAqIG9mIHBhdGVudCByaWdodHMgY2FuIGJlIGZvdW5kIGluIHRoZSBQQVRFTlRTIGZpbGUgaW4gdGhlIHNhbWUgZGlyZWN0b3J5LlxuICpcbiAqL1xuXG4ndXNlIHN0cmljdCc7XG5cbnZhciBSZWFjdCA9IHJlcXVpcmUoJy4vUmVhY3QnKTtcbnZhciBSZWFjdEFkZG9uc0RPTURlcGVuZGVuY2llcyA9IHJlcXVpcmUoJy4vUmVhY3RBZGRvbnNET01EZXBlbmRlbmNpZXMnKTtcblxudmFyIENTU0NvcmUgPSByZXF1aXJlKCdmYmpzL2xpYi9DU1NDb3JlJyk7XG52YXIgUmVhY3RUcmFuc2l0aW9uRXZlbnRzID0gcmVxdWlyZSgnLi9SZWFjdFRyYW5zaXRpb25FdmVudHMnKTtcblxudmFyIG9ubHlDaGlsZCA9IHJlcXVpcmUoJy4vb25seUNoaWxkJyk7XG5cbnZhciBUSUNLID0gMTc7XG5cbnZhciBSZWFjdENTU1RyYW5zaXRpb25Hcm91cENoaWxkID0gUmVhY3QuY3JlYXRlQ2xhc3Moe1xuICBkaXNwbGF5TmFtZTogJ1JlYWN0Q1NTVHJhbnNpdGlvbkdyb3VwQ2hpbGQnLFxuXG4gIHByb3BUeXBlczoge1xuICAgIG5hbWU6IFJlYWN0LlByb3BUeXBlcy5vbmVPZlR5cGUoW1JlYWN0LlByb3BUeXBlcy5zdHJpbmcsIFJlYWN0LlByb3BUeXBlcy5zaGFwZSh7XG4gICAgICBlbnRlcjogUmVhY3QuUHJvcFR5cGVzLnN0cmluZyxcbiAgICAgIGxlYXZlOiBSZWFjdC5Qcm9wVHlwZXMuc3RyaW5nLFxuICAgICAgYWN0aXZlOiBSZWFjdC5Qcm9wVHlwZXMuc3RyaW5nXG4gICAgfSksIFJlYWN0LlByb3BUeXBlcy5zaGFwZSh7XG4gICAgICBlbnRlcjogUmVhY3QuUHJvcFR5cGVzLnN0cmluZyxcbiAgICAgIGVudGVyQWN0aXZlOiBSZWFjdC5Qcm9wVHlwZXMuc3RyaW5nLFxuICAgICAgbGVhdmU6IFJlYWN0LlByb3BUeXBlcy5zdHJpbmcsXG4gICAgICBsZWF2ZUFjdGl2ZTogUmVhY3QuUHJvcFR5cGVzLnN0cmluZyxcbiAgICAgIGFwcGVhcjogUmVhY3QuUHJvcFR5cGVzLnN0cmluZyxcbiAgICAgIGFwcGVhckFjdGl2ZTogUmVhY3QuUHJvcFR5cGVzLnN0cmluZ1xuICAgIH0pXSkuaXNSZXF1aXJlZCxcblxuICAgIC8vIE9uY2Ugd2UgcmVxdWlyZSB0aW1lb3V0cyB0byBiZSBzcGVjaWZpZWQsIHdlIGNhbiByZW1vdmUgdGhlXG4gICAgLy8gYm9vbGVhbiBmbGFncyAoYXBwZWFyIGV0Yy4pIGFuZCBqdXN0IGFjY2VwdCBhIG51bWJlclxuICAgIC8vIG9yIGEgYm9vbCBmb3IgdGhlIHRpbWVvdXQgZmxhZ3MgKGFwcGVhclRpbWVvdXQgZXRjLilcbiAgICBhcHBlYXI6IFJlYWN0LlByb3BUeXBlcy5ib29sLFxuICAgIGVudGVyOiBSZWFjdC5Qcm9wVHlwZXMuYm9vbCxcbiAgICBsZWF2ZTogUmVhY3QuUHJvcFR5cGVzLmJvb2wsXG4gICAgYXBwZWFyVGltZW91dDogUmVhY3QuUHJvcFR5cGVzLm51bWJlcixcbiAgICBlbnRlclRpbWVvdXQ6IFJlYWN0LlByb3BUeXBlcy5udW1iZXIsXG4gICAgbGVhdmVUaW1lb3V0OiBSZWFjdC5Qcm9wVHlwZXMubnVtYmVyXG4gIH0sXG5cbiAgdHJhbnNpdGlvbjogZnVuY3Rpb24gKGFuaW1hdGlvblR5cGUsIGZpbmlzaENhbGxiYWNrLCB1c2VyU3BlY2lmaWVkRGVsYXkpIHtcbiAgICB2YXIgbm9kZSA9IFJlYWN0QWRkb25zRE9NRGVwZW5kZW5jaWVzLmdldFJlYWN0RE9NKCkuZmluZERPTU5vZGUodGhpcyk7XG5cbiAgICBpZiAoIW5vZGUpIHtcbiAgICAgIGlmIChmaW5pc2hDYWxsYmFjaykge1xuICAgICAgICBmaW5pc2hDYWxsYmFjaygpO1xuICAgICAgfVxuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHZhciBjbGFzc05hbWUgPSB0aGlzLnByb3BzLm5hbWVbYW5pbWF0aW9uVHlwZV0gfHwgdGhpcy5wcm9wcy5uYW1lICsgJy0nICsgYW5pbWF0aW9uVHlwZTtcbiAgICB2YXIgYWN0aXZlQ2xhc3NOYW1lID0gdGhpcy5wcm9wcy5uYW1lW2FuaW1hdGlvblR5cGUgKyAnQWN0aXZlJ10gfHwgY2xhc3NOYW1lICsgJy1hY3RpdmUnO1xuICAgIHZhciB0aW1lb3V0ID0gbnVsbDtcblxuICAgIHZhciBlbmRMaXN0ZW5lciA9IGZ1bmN0aW9uIChlKSB7XG4gICAgICBpZiAoZSAmJiBlLnRhcmdldCAhPT0gbm9kZSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTtcblxuICAgICAgQ1NTQ29yZS5yZW1vdmVDbGFzcyhub2RlLCBjbGFzc05hbWUpO1xuICAgICAgQ1NTQ29yZS5yZW1vdmVDbGFzcyhub2RlLCBhY3RpdmVDbGFzc05hbWUpO1xuXG4gICAgICBSZWFjdFRyYW5zaXRpb25FdmVudHMucmVtb3ZlRW5kRXZlbnRMaXN0ZW5lcihub2RlLCBlbmRMaXN0ZW5lcik7XG5cbiAgICAgIC8vIFVzdWFsbHkgdGhpcyBvcHRpb25hbCBjYWxsYmFjayBpcyB1c2VkIGZvciBpbmZvcm1pbmcgYW4gb3duZXIgb2ZcbiAgICAgIC8vIGEgbGVhdmUgYW5pbWF0aW9uIGFuZCB0ZWxsaW5nIGl0IHRvIHJlbW92ZSB0aGUgY2hpbGQuXG4gICAgICBpZiAoZmluaXNoQ2FsbGJhY2spIHtcbiAgICAgICAgZmluaXNoQ2FsbGJhY2soKTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgQ1NTQ29yZS5hZGRDbGFzcyhub2RlLCBjbGFzc05hbWUpO1xuXG4gICAgLy8gTmVlZCB0byBkbyB0aGlzIHRvIGFjdHVhbGx5IHRyaWdnZXIgYSB0cmFuc2l0aW9uLlxuICAgIHRoaXMucXVldWVDbGFzc0FuZE5vZGUoYWN0aXZlQ2xhc3NOYW1lLCBub2RlKTtcblxuICAgIC8vIElmIHRoZSB1c2VyIHNwZWNpZmllZCBhIHRpbWVvdXQgZGVsYXkuXG4gICAgaWYgKHVzZXJTcGVjaWZpZWREZWxheSkge1xuICAgICAgLy8gQ2xlYW4tdXAgdGhlIGFuaW1hdGlvbiBhZnRlciB0aGUgc3BlY2lmaWVkIGRlbGF5XG4gICAgICB0aW1lb3V0ID0gc2V0VGltZW91dChlbmRMaXN0ZW5lciwgdXNlclNwZWNpZmllZERlbGF5KTtcbiAgICAgIHRoaXMudHJhbnNpdGlvblRpbWVvdXRzLnB1c2godGltZW91dCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIERFUFJFQ0FURUQ6IHRoaXMgbGlzdGVuZXIgd2lsbCBiZSByZW1vdmVkIGluIGEgZnV0dXJlIHZlcnNpb24gb2YgcmVhY3RcbiAgICAgIFJlYWN0VHJhbnNpdGlvbkV2ZW50cy5hZGRFbmRFdmVudExpc3RlbmVyKG5vZGUsIGVuZExpc3RlbmVyKTtcbiAgICB9XG4gIH0sXG5cbiAgcXVldWVDbGFzc0FuZE5vZGU6IGZ1bmN0aW9uIChjbGFzc05hbWUsIG5vZGUpIHtcbiAgICB0aGlzLmNsYXNzTmFtZUFuZE5vZGVRdWV1ZS5wdXNoKHtcbiAgICAgIGNsYXNzTmFtZTogY2xhc3NOYW1lLFxuICAgICAgbm9kZTogbm9kZVxuICAgIH0pO1xuXG4gICAgaWYgKCF0aGlzLnRpbWVvdXQpIHtcbiAgICAgIHRoaXMudGltZW91dCA9IHNldFRpbWVvdXQodGhpcy5mbHVzaENsYXNzTmFtZUFuZE5vZGVRdWV1ZSwgVElDSyk7XG4gICAgfVxuICB9LFxuXG4gIGZsdXNoQ2xhc3NOYW1lQW5kTm9kZVF1ZXVlOiBmdW5jdGlvbiAoKSB7XG4gICAgaWYgKHRoaXMuaXNNb3VudGVkKCkpIHtcbiAgICAgIHRoaXMuY2xhc3NOYW1lQW5kTm9kZVF1ZXVlLmZvckVhY2goZnVuY3Rpb24gKG9iaikge1xuICAgICAgICBDU1NDb3JlLmFkZENsYXNzKG9iai5ub2RlLCBvYmouY2xhc3NOYW1lKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgICB0aGlzLmNsYXNzTmFtZUFuZE5vZGVRdWV1ZS5sZW5ndGggPSAwO1xuICAgIHRoaXMudGltZW91dCA9IG51bGw7XG4gIH0sXG5cbiAgY29tcG9uZW50V2lsbE1vdW50OiBmdW5jdGlvbiAoKSB7XG4gICAgdGhpcy5jbGFzc05hbWVBbmROb2RlUXVldWUgPSBbXTtcbiAgICB0aGlzLnRyYW5zaXRpb25UaW1lb3V0cyA9IFtdO1xuICB9LFxuXG4gIGNvbXBvbmVudFdpbGxVbm1vdW50OiBmdW5jdGlvbiAoKSB7XG4gICAgaWYgKHRoaXMudGltZW91dCkge1xuICAgICAgY2xlYXJUaW1lb3V0KHRoaXMudGltZW91dCk7XG4gICAgfVxuICAgIHRoaXMudHJhbnNpdGlvblRpbWVvdXRzLmZvckVhY2goZnVuY3Rpb24gKHRpbWVvdXQpIHtcbiAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTtcbiAgICB9KTtcblxuICAgIHRoaXMuY2xhc3NOYW1lQW5kTm9kZVF1ZXVlLmxlbmd0aCA9IDA7XG4gIH0sXG5cbiAgY29tcG9uZW50V2lsbEFwcGVhcjogZnVuY3Rpb24gKGRvbmUpIHtcbiAgICBpZiAodGhpcy5wcm9wcy5hcHBlYXIpIHtcbiAgICAgIHRoaXMudHJhbnNpdGlvbignYXBwZWFyJywgZG9uZSwgdGhpcy5wcm9wcy5hcHBlYXJUaW1lb3V0KTtcbiAgICB9IGVsc2Uge1xuICAgICAgZG9uZSgpO1xuICAgIH1cbiAgfSxcblxuICBjb21wb25lbnRXaWxsRW50ZXI6IGZ1bmN0aW9uIChkb25lKSB7XG4gICAgaWYgKHRoaXMucHJvcHMuZW50ZXIpIHtcbiAgICAgIHRoaXMudHJhbnNpdGlvbignZW50ZXInLCBkb25lLCB0aGlzLnByb3BzLmVudGVyVGltZW91dCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGRvbmUoKTtcbiAgICB9XG4gIH0sXG5cbiAgY29tcG9uZW50V2lsbExlYXZlOiBmdW5jdGlvbiAoZG9uZSkge1xuICAgIGlmICh0aGlzLnByb3BzLmxlYXZlKSB7XG4gICAgICB0aGlzLnRyYW5zaXRpb24oJ2xlYXZlJywgZG9uZSwgdGhpcy5wcm9wcy5sZWF2ZVRpbWVvdXQpO1xuICAgIH0gZWxzZSB7XG4gICAgICBkb25lKCk7XG4gICAgfVxuICB9LFxuXG4gIHJlbmRlcjogZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBvbmx5Q2hpbGQodGhpcy5wcm9wcy5jaGlsZHJlbik7XG4gIH1cbn0pO1xuXG5tb2R1bGUuZXhwb3J0cyA9IFJlYWN0Q1NTVHJhbnNpdGlvbkdyb3VwQ2hpbGQ7Il19