/**
 * Copyright 2013-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the BSD-style license found in the
 * LICENSE file in the root directory of this source tree. An additional grant
 * of patent rights can be found in the PATENTS file in the same directory.
 *
 * 
 */

'use strict';

var _prodInvariant = require('./reactProdInvariant');

var EventPluginUtils = require('./EventPluginUtils');

var invariant = require('fbjs/lib/invariant');
var warning = require('fbjs/lib/warning');

var isEndish = EventPluginUtils.isEndish,
    isMoveish = EventPluginUtils.isMoveish,
    isStartish = EventPluginUtils.isStartish;

/**
 * Tracks the position and time of each active touch by `touch.identifier`. We
 * should typically only see IDs in the range of 1-20 because IDs get recycled
 * when touches end and start again.
 */

var MAX_TOUCH_BANK = 20;
var touchBank = [];
var touchHistory = {
  touchBank: touchBank,
  numberActiveTouches: 0,
  // If there is only one active touch, we remember its location. This prevents
  // us having to loop through all of the touches all the time in the most
  // common case.
  indexOfSingleActiveTouch: -1,
  mostRecentTimeStamp: 0
};

function timestampForTouch(touch) {
  // The legacy internal implementation provides "timeStamp", which has been
  // renamed to "timestamp". Let both work for now while we iron it out
  // TODO (evv): rename timeStamp to timestamp in internal code
  return touch.timeStamp || touch.timestamp;
}

/**
 * TODO: Instead of making gestures recompute filtered velocity, we could
 * include a built in velocity computation that can be reused globally.
 */
function createTouchRecord(touch) {
  return {
    touchActive: true,
    startPageX: touch.pageX,
    startPageY: touch.pageY,
    startTimeStamp: timestampForTouch(touch),
    currentPageX: touch.pageX,
    currentPageY: touch.pageY,
    currentTimeStamp: timestampForTouch(touch),
    previousPageX: touch.pageX,
    previousPageY: touch.pageY,
    previousTimeStamp: timestampForTouch(touch)
  };
}

function resetTouchRecord(touchRecord, touch) {
  touchRecord.touchActive = true;
  touchRecord.startPageX = touch.pageX;
  touchRecord.startPageY = touch.pageY;
  touchRecord.startTimeStamp = timestampForTouch(touch);
  touchRecord.currentPageX = touch.pageX;
  touchRecord.currentPageY = touch.pageY;
  touchRecord.currentTimeStamp = timestampForTouch(touch);
  touchRecord.previousPageX = touch.pageX;
  touchRecord.previousPageY = touch.pageY;
  touchRecord.previousTimeStamp = timestampForTouch(touch);
}

function getTouchIdentifier(_ref) {
  var identifier = _ref.identifier;

  !(identifier != null) ? process.env.NODE_ENV !== 'production' ? invariant(false, 'Touch object is missing identifier.') : _prodInvariant('138') : void 0;
  process.env.NODE_ENV !== 'production' ? warning(identifier <= MAX_TOUCH_BANK, 'Touch identifier %s is greater than maximum supported %s which causes ' + 'performance issues backfilling array locations for all of the indices.', identifier, MAX_TOUCH_BANK) : void 0;
  return identifier;
}

function recordTouchStart(touch) {
  var identifier = getTouchIdentifier(touch);
  var touchRecord = touchBank[identifier];
  if (touchRecord) {
    resetTouchRecord(touchRecord, touch);
  } else {
    touchBank[identifier] = createTouchRecord(touch);
  }
  touchHistory.mostRecentTimeStamp = timestampForTouch(touch);
}

function recordTouchMove(touch) {
  var touchRecord = touchBank[getTouchIdentifier(touch)];
  if (touchRecord) {
    touchRecord.touchActive = true;
    touchRecord.previousPageX = touchRecord.currentPageX;
    touchRecord.previousPageY = touchRecord.currentPageY;
    touchRecord.previousTimeStamp = touchRecord.currentTimeStamp;
    touchRecord.currentPageX = touch.pageX;
    touchRecord.currentPageY = touch.pageY;
    touchRecord.currentTimeStamp = timestampForTouch(touch);
    touchHistory.mostRecentTimeStamp = timestampForTouch(touch);
  } else {
    console.error('Cannot record touch move without a touch start.\n' + 'Touch Move: %s\n', 'Touch Bank: %s', printTouch(touch), printTouchBank());
  }
}

function recordTouchEnd(touch) {
  var touchRecord = touchBank[getTouchIdentifier(touch)];
  if (touchRecord) {
    touchRecord.touchActive = false;
    touchRecord.previousPageX = touchRecord.currentPageX;
    touchRecord.previousPageY = touchRecord.currentPageY;
    touchRecord.previousTimeStamp = touchRecord.currentTimeStamp;
    touchRecord.currentPageX = touch.pageX;
    touchRecord.currentPageY = touch.pageY;
    touchRecord.currentTimeStamp = timestampForTouch(touch);
    touchHistory.mostRecentTimeStamp = timestampForTouch(touch);
  } else {
    console.error('Cannot record touch end without a touch start.\n' + 'Touch End: %s\n', 'Touch Bank: %s', printTouch(touch), printTouchBank());
  }
}

function printTouch(touch) {
  return JSON.stringify({
    identifier: touch.identifier,
    pageX: touch.pageX,
    pageY: touch.pageY,
    timestamp: timestampForTouch(touch)
  });
}

function printTouchBank() {
  var printed = JSON.stringify(touchBank.slice(0, MAX_TOUCH_BANK));
  if (touchBank.length > MAX_TOUCH_BANK) {
    printed += ' (original size: ' + touchBank.length + ')';
  }
  return printed;
}

var ResponderTouchHistoryStore = {
  recordTouchTrack: function recordTouchTrack(topLevelType, nativeEvent) {
    if (isMoveish(topLevelType)) {
      nativeEvent.changedTouches.forEach(recordTouchMove);
    } else if (isStartish(topLevelType)) {
      nativeEvent.changedTouches.forEach(recordTouchStart);
      touchHistory.numberActiveTouches = nativeEvent.touches.length;
      if (touchHistory.numberActiveTouches === 1) {
        touchHistory.indexOfSingleActiveTouch = nativeEvent.touches[0].identifier;
      }
    } else if (isEndish(topLevelType)) {
      nativeEvent.changedTouches.forEach(recordTouchEnd);
      touchHistory.numberActiveTouches = nativeEvent.touches.length;
      if (touchHistory.numberActiveTouches === 1) {
        for (var i = 0; i < touchBank.length; i++) {
          var touchTrackToCheck = touchBank[i];
          if (touchTrackToCheck != null && touchTrackToCheck.touchActive) {
            touchHistory.indexOfSingleActiveTouch = i;
            break;
          }
        }
        if (process.env.NODE_ENV !== 'production') {
          var activeRecord = touchBank[touchHistory.indexOfSingleActiveTouch];
          process.env.NODE_ENV !== 'production' ? warning(activeRecord != null && activeRecord.touchActive, 'Cannot find single active touch.') : void 0;
        }
      }
    }
  },

  touchHistory: touchHistory
};

module.exports = ResponderTouchHistoryStore;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3B1YmxpYy9saWIvcmVhY3QtZG9tL2xpYi9SZXNwb25kZXJUb3VjaEhpc3RvcnlTdG9yZS5qcyJdLCJuYW1lcyI6WyJfcHJvZEludmFyaWFudCIsInJlcXVpcmUiLCJFdmVudFBsdWdpblV0aWxzIiwiaW52YXJpYW50Iiwid2FybmluZyIsImlzRW5kaXNoIiwiaXNNb3ZlaXNoIiwiaXNTdGFydGlzaCIsIk1BWF9UT1VDSF9CQU5LIiwidG91Y2hCYW5rIiwidG91Y2hIaXN0b3J5IiwibnVtYmVyQWN0aXZlVG91Y2hlcyIsImluZGV4T2ZTaW5nbGVBY3RpdmVUb3VjaCIsIm1vc3RSZWNlbnRUaW1lU3RhbXAiLCJ0aW1lc3RhbXBGb3JUb3VjaCIsInRvdWNoIiwidGltZVN0YW1wIiwidGltZXN0YW1wIiwiY3JlYXRlVG91Y2hSZWNvcmQiLCJ0b3VjaEFjdGl2ZSIsInN0YXJ0UGFnZVgiLCJwYWdlWCIsInN0YXJ0UGFnZVkiLCJwYWdlWSIsInN0YXJ0VGltZVN0YW1wIiwiY3VycmVudFBhZ2VYIiwiY3VycmVudFBhZ2VZIiwiY3VycmVudFRpbWVTdGFtcCIsInByZXZpb3VzUGFnZVgiLCJwcmV2aW91c1BhZ2VZIiwicHJldmlvdXNUaW1lU3RhbXAiLCJyZXNldFRvdWNoUmVjb3JkIiwidG91Y2hSZWNvcmQiLCJnZXRUb3VjaElkZW50aWZpZXIiLCJfcmVmIiwiaWRlbnRpZmllciIsInByb2Nlc3MiLCJlbnYiLCJOT0RFX0VOViIsInJlY29yZFRvdWNoU3RhcnQiLCJyZWNvcmRUb3VjaE1vdmUiLCJjb25zb2xlIiwiZXJyb3IiLCJwcmludFRvdWNoIiwicHJpbnRUb3VjaEJhbmsiLCJyZWNvcmRUb3VjaEVuZCIsIkpTT04iLCJzdHJpbmdpZnkiLCJwcmludGVkIiwic2xpY2UiLCJsZW5ndGgiLCJSZXNwb25kZXJUb3VjaEhpc3RvcnlTdG9yZSIsInJlY29yZFRvdWNoVHJhY2siLCJ0b3BMZXZlbFR5cGUiLCJuYXRpdmVFdmVudCIsImNoYW5nZWRUb3VjaGVzIiwiZm9yRWFjaCIsInRvdWNoZXMiLCJpIiwidG91Y2hUcmFja1RvQ2hlY2siLCJhY3RpdmVSZWNvcmQiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7QUFXQTs7QUFFQSxJQUFJQSxpQkFBaUJDLFFBQVEsc0JBQVIsQ0FBckI7O0FBRUEsSUFBSUMsbUJBQW1CRCxRQUFRLG9CQUFSLENBQXZCOztBQUVBLElBQUlFLFlBQVlGLFFBQVEsb0JBQVIsQ0FBaEI7QUFDQSxJQUFJRyxVQUFVSCxRQUFRLGtCQUFSLENBQWQ7O0FBRUEsSUFBSUksV0FBV0gsaUJBQWlCRyxRQUFoQztBQUFBLElBQ0lDLFlBQVlKLGlCQUFpQkksU0FEakM7QUFBQSxJQUVJQyxhQUFhTCxpQkFBaUJLLFVBRmxDOztBQUlBOzs7Ozs7QUFNQSxJQUFJQyxpQkFBaUIsRUFBckI7QUFDQSxJQUFJQyxZQUFZLEVBQWhCO0FBQ0EsSUFBSUMsZUFBZTtBQUNqQkQsYUFBV0EsU0FETTtBQUVqQkUsdUJBQXFCLENBRko7QUFHakI7QUFDQTtBQUNBO0FBQ0FDLDRCQUEwQixDQUFDLENBTlY7QUFPakJDLHVCQUFxQjtBQVBKLENBQW5COztBQVVBLFNBQVNDLGlCQUFULENBQTJCQyxLQUEzQixFQUFrQztBQUNoQztBQUNBO0FBQ0E7QUFDQSxTQUFPQSxNQUFNQyxTQUFOLElBQW1CRCxNQUFNRSxTQUFoQztBQUNEOztBQUVEOzs7O0FBSUEsU0FBU0MsaUJBQVQsQ0FBMkJILEtBQTNCLEVBQWtDO0FBQ2hDLFNBQU87QUFDTEksaUJBQWEsSUFEUjtBQUVMQyxnQkFBWUwsTUFBTU0sS0FGYjtBQUdMQyxnQkFBWVAsTUFBTVEsS0FIYjtBQUlMQyxvQkFBZ0JWLGtCQUFrQkMsS0FBbEIsQ0FKWDtBQUtMVSxrQkFBY1YsTUFBTU0sS0FMZjtBQU1MSyxrQkFBY1gsTUFBTVEsS0FOZjtBQU9MSSxzQkFBa0JiLGtCQUFrQkMsS0FBbEIsQ0FQYjtBQVFMYSxtQkFBZWIsTUFBTU0sS0FSaEI7QUFTTFEs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d0QsZ0JBQWdCLElBQWhCLElBQXdCQSxhQUFhekMsV0FBN0MsRUFBMEQsa0NBQTFELENBQXhDLEdBQXdJLEtBQUssQ0FBN0k7QUFDRDtBQUNGO0FBQ0Y7QUFDRixHQTNCOEI7O0FBOEIvQlQsZ0JBQWNBO0FBOUJpQixDQUFqQzs7QUFpQ0FtRCxPQUFPQyxPQUFQLEdBQWlCWCwwQkFBakIiLCJmaWxlIjoiUmVzcG9uZGVyVG91Y2hIaXN0b3J5U3RvcmUuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENvcHlyaWdodCAyMDEzLXByZXNlbnQsIEZhY2Vib29rLCBJbmMuXG4gKiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIEJTRC1zdHlsZSBsaWNlbnNlIGZvdW5kIGluIHRoZVxuICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLiBBbiBhZGRpdGlvbmFsIGdyYW50XG4gKiBvZiBwYXRlbnQgcmlnaHRzIGNhbiBiZSBmb3VuZCBpbiB0aGUgUEFURU5UUyBmaWxlIGluIHRoZSBzYW1lIGRpcmVjdG9yeS5cbiAqXG4gKiBcbiAqL1xuXG4ndXNlIHN0cmljdCc7XG5cbnZhciBfcHJvZEludmFyaWFudCA9IHJlcXVpcmUoJy4vcmVhY3RQcm9kSW52YXJpYW50Jyk7XG5cbnZhciBFdmVudFBsdWdpblV0aWxzID0gcmVxdWlyZSgnLi9FdmVudFBsdWdpblV0aWxzJyk7XG5cbnZhciBpbnZhcmlhbnQgPSByZXF1aXJlKCdmYmpzL2xpYi9pbnZhcmlhbnQnKTtcbnZhciB3YXJuaW5nID0gcmVxdWlyZSgnZmJqcy9saWIvd2FybmluZycpO1xuXG52YXIgaXNFbmRpc2ggPSBFdmVudFBsdWdpblV0aWxzLmlzRW5kaXNoLFxuICAgIGlzTW92ZWlzaCA9IEV2ZW50UGx1Z2luVXRpbHMuaXNNb3ZlaXNoLFxuICAgIGlzU3RhcnRpc2ggPSBFdmVudFBsdWdpblV0aWxzLmlzU3RhcnRpc2g7XG5cbi8qKlxuICogVHJhY2tzIHRoZSBwb3NpdGlvbiBhbmQgdGltZSBvZiBlYWNoIGFjdGl2ZSB0b3VjaCBieSBgdG91Y2guaWRlbnRpZmllcmAuIFdlXG4gKiBzaG91bGQgdHlwaWNhbGx5IG9ubHkgc2VlIElEcyBpbiB0aGUgcmFuZ2Ugb2YgMS0yMCBiZWNhdXNlIElEcyBnZXQgcmVjeWNsZWRcbiAqIHdoZW4gdG91Y2hlcyBlbmQgYW5kIHN0YXJ0IGFnYWluLlxuICovXG5cbnZhciBNQVhfVE9VQ0hfQkFOSyA9IDIwO1xudmFyIHRvdWNoQmFuayA9IFtdO1xudmFyIHRvdWNoSGlzdG9yeSA9IHtcbiAgdG91Y2hCYW5rOiB0b3VjaEJhbmssXG4gIG51bWJlckFjdGl2ZVRvdWNoZXM6IDAsXG4gIC8vIElmIHRoZXJlIGlzIG9ubHkgb25lIGFjdGl2ZSB0b3VjaCwgd2UgcmVtZW1iZXIgaXRzIGxvY2F0aW9uLiBUaGlzIHByZXZlbnRzXG4gIC8vIHVzIGhhdmluZyB0byBsb29wIHRocm91Z2ggYWxsIG9mIHRoZSB0b3VjaGVzIGFsbCB0aGUgdGltZSBpbiB0aGUgbW9zdFxuICAvLyBjb21tb24gY2FzZS5cbiAgaW5kZXhPZlNpbmdsZUFjdGl2ZVRvdWNoOiAtMSxcbiAgbW9zdFJlY2VudFRpbWVTdGFtcDogMFxufTtcblxuZnVuY3Rpb24gdGltZXN0YW1wRm9yVG91Y2godG91Y2gpIHtcbiAgLy8gVGhlIGxlZ2FjeSBpbnRlcm5hbCBpbXBsZW1lbnRhdGlvbiBwcm92aWRlcyBcInRpbWVTdGFtcFwiLCB3aGljaCBoYXMgYmVlblxuICAvLyByZW5hbWVkIHRvIFwidGltZXN0YW1wXCIuIExldCBib3RoIHdvcmsgZm9yIG5vdyB3aGlsZSB3ZSBpcm9uIGl0IG91dFxuICAvLyBUT0RPIChldnYpOiByZW5hbWUgdGltZVN0YW1wIHRvIHRpbWVzdGFtcCBpbiBpbnRlcm5hbCBjb2RlXG4gIHJldHVybiB0b3VjaC50aW1lU3RhbXAgfHwgdG91Y2gudGltZXN0YW1wO1xufVxuXG4vKipcbiAqIFRPRE86IEluc3RlYWQgb2YgbWFraW5nIGdlc3R1cmVzIHJlY29tcHV0ZSBmaWx0ZXJlZCB2ZWxvY2l0eSwgd2UgY291bGRcbiAqIGluY2x1ZGUgYSBidWlsdCBpbiB2ZWxvY2l0eSBjb21wdXRhdGlvbiB0aGF0IGNhbiBiZSByZXVzZWQgZ2xvYmFsbHkuXG4gKi9cbmZ1bmN0aW9uIGNyZWF0ZVRvdWNoUmVjb3JkKHRvdWNoKSB7XG4gIHJldHVybiB7XG4gICAgdG91Y2hBY3RpdmU6IHRydWUsXG4gICAgc3RhcnRQYWdlWDogdG91Y2gucGFnZVgsXG4gICAgc3RhcnRQYWdlWTogdG91Y2gucGFnZVksXG4gICAgc3RhcnRUaW1lU3RhbXA6IHRpbWVzdGFtcEZvclRvdWNoKHRvdWNoKSxcbiAgICBjdXJyZW50UGFnZVg6IHRvdWNoLnBhZ2VYLFxuICAgIGN1cnJlbnRQYWdlWTogdG91Y2gucGFnZVksXG4gICAgY3VycmVudFRpbWVTdGFtcDogdGltZXN0YW1wRm9yVG91Y2godG91Y2gpLFxuICAgIHByZXZpb3VzUGFnZVg6IHRvdWNoLnBhZ2VYLFxuICAgIHByZXZpb3VzUGFnZVk6IHRvdWNoLnBhZ2VZLFxuICAgIHByZXZpb3VzVGltZVN0YW1wOiB0aW1lc3RhbXBGb3JUb3VjaCh0b3VjaClcbiAgfTtcbn1cblxuZnVuY3Rpb24gcmVzZXRUb3VjaFJlY29yZCh0b3VjaFJlY29yZCwgdG91Y2gpIHtcbiAgdG91Y2hSZWNvcmQudG91Y2hBY3RpdmUgPSB0cnVlO1xuICB0b3VjaFJlY29yZC5zdGFydFBhZ2VYID0gdG91Y2gucGFnZVg7XG4gIHRvdWNoUmVjb3JkLnN0YXJ0UGFnZVkgPSB0b3VjaC5wYWdlWTtcbiAgdG91Y2hSZWNvcmQuc3RhcnRUaW1lU3RhbXAgPSB0aW1lc3RhbXBGb3JUb3VjaCh0b3VjaCk7XG4gIHRvdWNoUmVjb3JkLmN1cnJlbnRQYWdlWCA9IHRvdWNoLnBhZ2VYO1xuICB0b3VjaFJlY29yZC5jdXJyZW50UGFnZVkgPSB0b3VjaC5wYWdlWTtcbiAgdG91Y2hSZWNvcmQuY3VycmVudFRpbWVTdGFtcCA9IHRpbWVzdGFtcEZvclRvdWNoKHRvdWNoKTtcbiAgdG91Y2hSZWNvcmQucHJldmlvdXNQYWdlWCA9IHRvdWNoLnBhZ2VYO1xuICB0b3VjaFJlY29yZC5wcmV2aW91c1BhZ2VZID0gdG91Y2gucGFnZVk7XG4gIHRvdWNoUmVjb3JkLnByZXZpb3VzVGltZVN0YW1wID0gdGltZXN0YW1wRm9yVG91Y2godG91Y2gpO1xufVxuXG5mdW5jdGlvbiBnZXRUb3VjaElkZW50aWZpZXIoX3JlZikge1xuICB2YXIgaWRlbnRpZmllciA9IF9yZWYuaWRlbnRpZmllcjtcblxuICAhKGlkZW50aWZpZXIgIT0gbnVsbCkgPyBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nID8gaW52YXJpYW50KGZhbHNlLCAnVG91Y2ggb2JqZWN0IGlzIG1pc3NpbmcgaWRlbnRpZmllci4nKSA6IF9wcm9kSW52YXJpYW50KCcxMzgnKSA6IHZvaWQgMDtcbiAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgIT09ICdwcm9kdWN0aW9uJyA/IHdhcm5pbmcoaWRlbnRpZmllciA8PSBNQVhfVE9VQ0hfQkFOSywgJ1RvdWNoIGlkZW50aWZpZXIgJXMgaXMgZ3JlYXRlciB0aGFuIG1heGltdW0gc3VwcG9ydGVkICVzIHdoaWNoIGNhdXNlcyAnICsgJ3BlcmZvcm1hbmNlIGlzc3VlcyBiYWNrZmlsbGluZyBhcnJheSBsb2NhdGlvbnMgZm9yIGFsbCBvZiB0aGUgaW5kaWNlcy4nLCBpZGVudGlmaWVyLCBNQVhfVE9VQ0hfQkFOSykgOiB2b2lkIDA7XG4gIHJldHVybiBpZGVudGlmaWVyO1xufVxuXG5mdW5jdGlvbiByZWNvcmRUb3VjaFN0YXJ0KHRvdWNoKSB7XG4gIHZhciBpZGVudGlmaWVyID0gZ2V0VG91Y2hJZGVudGlmaWVyKHRvdWNoKTtcbiAgdmFyIHRvdWNoUmVjb3JkID0gdG91Y2hCYW5rW2lkZW50aWZpZXJdO1xuICBpZiAodG91Y2hSZWNvcmQpIHtcbiAgICByZXNldFRvdWNoUmVjb3JkKHRvdWNoUmVjb3JkLCB0b3VjaCk7XG4gIH0gZWxzZSB7XG4gICAgdG91Y2hCYW5rW2lkZW50aWZpZXJdID0gY3JlYXRlVG91Y2hSZWNvcmQodG91Y2gpO1xuICB9XG4gIHRvdWNoSGlzdG9yeS5tb3N0UmVjZW50VGltZVN0YW1wID0gdGltZXN0YW1wRm9yVG91Y2godG91Y2gpO1xufVxuXG5mdW5jdGlvbiByZWNvcmRUb3VjaE1vdmUodG91Y2gpIHtcbiAgdmFyIHRvdWNoUmVjb3JkID0gdG91Y2hCYW5rW2dldFRvdWNoSWRlbnRpZmllcih0b3VjaCldO1xuICBpZiAodG91Y2hSZWNvcmQpIHtcbiAgICB0b3VjaFJlY29yZC50b3VjaEFjdGl2ZSA9IHRydWU7XG4gICAgdG91Y2hSZWNvcmQucHJldmlvdXNQYWdlWCA9IHRvdWNoUmVjb3JkLmN1cnJlbnRQYWdlWDtcbiAgICB0b3VjaFJlY29yZC5wcmV2aW91c1BhZ2VZID0gdG91Y2hSZWNvcmQuY3VycmVudFBhZ2VZO1xuICAgIHRvdWNoUmVjb3JkLnByZXZpb3VzVGltZVN0YW1wID0gdG91Y2hSZWNvcmQuY3VycmVudFRpbWVTdGFtcDtcbiAgICB0b3VjaFJlY29yZC5jdXJyZW50UGFnZVggPSB0b3VjaC5wYWdlWDtcbiAgICB0b3VjaFJlY29yZC5jdXJyZW50UGFnZVkgPSB0b3VjaC5wYWdlWTtcbiAgICB0b3VjaFJlY29yZC5jdXJyZW50VGltZVN0YW1wID0gdGltZXN0YW1wRm9yVG91Y2godG91Y2gpO1xuICAgIHRvdWNoSGlzdG9yeS5tb3N0UmVjZW50VGltZVN0YW1wID0gdGltZXN0YW1wRm9yVG91Y2godG91Y2gpO1xuICB9IGVsc2Uge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0Nhbm5vdCByZWNvcmQgdG91Y2ggbW92ZSB3aXRob3V0IGEgdG91Y2ggc3RhcnQuXFxuJyArICdUb3VjaCBNb3ZlOiAlc1xcbicsICdUb3VjaCBCYW5rOiAlcycsIHByaW50VG91Y2godG91Y2gpLCBwcmludFRvdWNoQmFuaygpKTtcbiAgfVxufVxuXG5mdW5jdGlvbiByZWNvcmRUb3VjaEVuZCh0b3VjaCkge1xuICB2YXIgdG91Y2hSZWNvcmQgPSB0b3VjaEJhbmtbZ2V0VG91Y2hJZGVudGlmaWVyKHRvdWNoKV07XG4gIGlmICh0b3VjaFJlY29yZCkge1xuICAgIHRvdWNoUmVjb3JkLnRvdWNoQWN0aXZlID0gZmFsc2U7XG4gICAgdG91Y2hSZWNvcmQucHJldmlvdXNQYWdlWCA9IHRvdWNoUmVjb3JkLmN1cnJlbnRQYWdlWDtcbiAgICB0b3VjaFJlY29yZC5wcmV2aW91c1BhZ2VZID0gdG91Y2hSZWNvcmQuY3VycmVudFBhZ2VZO1xuICAgIHRvdWNoUmVjb3JkLnByZXZpb3VzVGltZVN0YW1wID0gdG91Y2hSZWNvcmQuY3VycmVudFRpbWVTdGFtcDtcbiAgICB0b3VjaFJlY29yZC5jdXJyZW50UGFnZVggPSB0b3VjaC5wYWdlWDtcbiAgICB0b3VjaFJlY29yZC5jdXJyZW50UGFnZVkgPSB0b3VjaC5wYWdlWTtcbiAgICB0b3VjaFJlY29yZC5jdXJyZW50VGltZVN0YW1wID0gdGltZXN0YW1wRm9yVG91Y2godG91Y2gpO1xuICAgIHRvdWNoSGlzdG9yeS5tb3N0UmVjZW50VGltZVN0YW1wID0gdGltZXN0YW1wRm9yVG91Y2godG91Y2gpO1xuICB9IGVsc2Uge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0Nhbm5vdCByZWNvcmQgdG91Y2ggZW5kIHdpdGhvdXQgYSB0b3VjaCBzdGFydC5cXG4nICsgJ1RvdWNoIEVuZDogJXNcXG4nLCAnVG91Y2ggQmFuazogJXMnLCBwcmludFRvdWNoKHRvdWNoKSwgcHJpbnRUb3VjaEJhbmsoKSk7XG4gIH1cbn1cblxuZnVuY3Rpb24gcHJpbnRUb3VjaCh0b3VjaCkge1xuICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoe1xuICAgIGlkZW50aWZpZXI6IHRvdWNoLmlkZW50aWZpZXIsXG4gICAgcGFnZVg6IHRvdWNoLnBhZ2VYLFxuICAgIHBhZ2VZOiB0b3VjaC5wYWdlWSxcbiAgICB0aW1lc3RhbXA6IHRpbWVzdGFtcEZvclRvdWNoKHRvdWNoKVxuICB9KTtcbn1cblxuZnVuY3Rpb24gcHJpbnRUb3VjaEJhbmsoKSB7XG4gIHZhciBwcmludGVkID0gSlNPTi5zdHJpbmdpZnkodG91Y2hCYW5rLnNsaWNlKDAsIE1BWF9UT1VDSF9CQU5LKSk7XG4gIGlmICh0b3VjaEJhbmsubGVuZ3RoID4gTUFYX1RPVUNIX0JBTkspIHtcbiAgICBwcmludGVkICs9ICcgKG9yaWdpbmFsIHNpemU6ICcgKyB0b3VjaEJhbmsubGVuZ3RoICsgJyknO1xuICB9XG4gIHJldHVybiBwcmludGVkO1xufVxuXG52YXIgUmVzcG9uZGVyVG91Y2hIaXN0b3J5U3RvcmUgPSB7XG4gIHJlY29yZFRvdWNoVHJhY2s6IGZ1bmN0aW9uICh0b3BMZXZlbFR5cGUsIG5hdGl2ZUV2ZW50KSB7XG4gICAgaWYgKGlzTW92ZWlzaCh0b3BMZXZlbFR5cGUpKSB7XG4gICAgICBuYXRpdmVFdmVudC5jaGFuZ2VkVG91Y2hlcy5mb3JFYWNoKHJlY29yZFRvdWNoTW92ZSk7XG4gICAgfSBlbHNlIGlmIChpc1N0YXJ0aXNoKHRvcExldmVsVHlwZSkpIHtcbiAgICAgIG5hdGl2ZUV2ZW50LmNoYW5nZWRUb3VjaGVzLmZvckVhY2gocmVjb3JkVG91Y2hTdGFydCk7XG4gICAgICB0b3VjaEhpc3RvcnkubnVtYmVyQWN0aXZlVG91Y2hlcyA9IG5hdGl2ZUV2ZW50LnRvdWNoZXMubGVuZ3RoO1xuICAgICAgaWYgKHRvdWNoSGlzdG9yeS5udW1iZXJBY3RpdmVUb3VjaGVzID09PSAxKSB7XG4gICAgICAgIHRvdWNoSGlzdG9yeS5pbmRleE9mU2luZ2xlQWN0aXZlVG91Y2ggPSBuYXRpdmVFdmVudC50b3VjaGVzWzBdLmlkZW50aWZpZXI7XG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChpc0VuZGlzaCh0b3BMZXZlbFR5cGUpKSB7XG4gICAgICBuYXRpdmVFdmVudC5jaGFuZ2VkVG91Y2hlcy5mb3JFYWNoKHJlY29yZFRvdWNoRW5kKTtcbiAgICAgIHRvdWNoSGlzdG9yeS5udW1iZXJBY3RpdmVUb3VjaGVzID0gbmF0aXZlRXZlbnQudG91Y2hlcy5sZW5ndGg7XG4gICAgICBpZiAodG91Y2hIaXN0b3J5Lm51bWJlckFjdGl2ZVRvdWNoZXMgPT09IDEpIHtcbiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0b3VjaEJhbmsubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICB2YXIgdG91Y2hUcmFja1RvQ2hlY2sgPSB0b3VjaEJhbmtbaV07XG4gICAgICAgICAgaWYgKHRvdWNoVHJhY2tUb0NoZWNrICE9IG51bGwgJiYgdG91Y2hUcmFja1RvQ2hlY2sudG91Y2hBY3RpdmUpIHtcbiAgICAgICAgICAgIHRvdWNoSGlzdG9yeS5pbmRleE9mU2luZ2xlQWN0aXZlVG91Y2ggPSBpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7XG4gICAgICAgICAgdmFyIGFjdGl2ZVJlY29yZCA9IHRvdWNoQmFua1t0b3VjaEhpc3RvcnkuaW5kZXhPZlNpbmdsZUFjdGl2ZVRvdWNoXTtcbiAgICAgICAgICBwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nID8gd2FybmluZyhhY3RpdmVSZWNvcmQgIT0gbnVsbCAmJiBhY3RpdmVSZWNvcmQudG91Y2hBY3RpdmUsICdDYW5ub3QgZmluZCBzaW5nbGUgYWN0aXZlIHRvdWNoLicpIDogdm9pZCAwO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9LFxuXG5cbiAgdG91Y2hIaXN0b3J5OiB0b3VjaEhpc3Rvcnlcbn07XG5cbm1vZHVsZS5leHBvcnRzID0gUmVzcG9uZGVyVG91Y2hIaXN0b3J5U3RvcmU7Il19